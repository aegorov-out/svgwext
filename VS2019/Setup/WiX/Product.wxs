<?xml version="1.0" encoding="UTF-8"?>

<?if $(var.Platform) = x64?>
	<?define Win64 = "yes"?>
	<?define WinVer = "VersionNT64"?>
	<?define ProgramFilesDir = "ProgramFiles64Folder"?>
	<?define PlatformUIText = "(64-bit)"?>
	<?define UpgradeCode="0A423FBD-1ECF-4DD6-BD63-CDF914E2792F"?>
<?else?>
	<?define Win64 = "no"?>
	<?define WinVer = "VersionNT"?>
	<?define ProgramFilesDir = "ProgramFilesFolder"?>
	<?define PlatformUIText = "(32-bit)"?>
	<?define UpgradeCode="0A423FBD-1ECF-4DD6-BD63-CDF914E2792E"?>
<?endif?>

<?define ProductId="EB8EE7FC-449D-4451-A5E9-721C49A4B892"?>
<?define ProductVersion="1.0.2021"?>
<?define ProductName="SVG/WMF Extension"?>
<?define ProductDescr="SVG/WMF/EMF WIC decoder and thumbnail provider"?>
<?define KeyName="SVGWExt"?>
<?ifdef Debug?>
<?define FileSourcePath = "$(var.SolutionDir)..\.$(var.Configuration)\$(var.Platform)\"?>
<?else?>
<?define FileSourcePath = "$(var.SolutionDir)..\$(var.Configuration)\$(var.Platform)\"?>
<?endif?>
<?define ResourcePath = "$(var.SolutionDir)RES"?>
<?define ProductURL = "https://github.com/aegorov-out/svgwext"?>

<?define MainFilesGuid="C1D96019-6E8C-46D6-9CE2-4708E80D9FB0"?>
<?define DocFilesGuid="CF09209C-ADC8-4D13-9924-0BB0CF7C45A4"?>
<?define SVGDecoderGuid="C39CB54F-764E-428A-B76E-A59312864F1D"?>
<?define WMFDecoderGuid="C9F22879-5259-4416-AF8D-50720CE2C6A5"?>
<?define SVGThumbsGuid="C650E6FD-4154-466E-82AA-C835D8871014"?>
<?define WMFThumbsGuid="CF74B553-FE24-4944-8CCC-68DBDE2E3236"?>
<?define SVGTypesGuid="C0A2E0C4-F5C9-4A7D-948F-F7F59C539B68"?>
<?define WMFTypesGuid="C1F7EAFE-AB85-43A7-A714-178EF6986470"?>

<?define CLSID_SvgDecoder="{0FF41E38-A793-45FF-9F38-5278DC444D57}"?>
<?define CLSID_WmfDecoder="{9DDB0D52-BDEE-4451-903D-27B29FA407B0}"?>
<?define CLSID_SvgThumbnailProvider="{A3699533-14C8-4D18-80A4-3484B11EDC85}"?>
<?define CLSID_WmfThumbnailProvider="{ACDB5DAE-C8D0-4443-A86D-CE94E679670C}"?>
<?define GUID_AE_VendorID="{AE97E52A-51BC-41FB-871A-FC9B86FB20A2}"?>
<?define GUID_ContainerFormatSvg="{28EA8895-834D-4941-8794-7EE5B5A05356}"?>
<?define GUID_ContainerFormatWmf="{C1D289A3-A846-47C7-9F94-E5E8F6AC4D46}"?>
<?define GUID_WICPixelFormat32bppBGRA="{6FDDC324-4E03-4BFE-B185-3D77768DC90F}"?>
<?define GUID_WICPixelFormat32bppPBGRA="{6FDDC324-4E03-4BFE-B185-3D77768DC910}"?>

<?define RegPath_Setup="Software\Microsoft\Windows\CurrentVersion"?>
<?define RegPath_SetupNT="Software\Microsoft\Windows NT\CurrentVersion"?>
<?define RegPath_WICDecoders="CLSID\{7ED96837-96F0-4812-B211-F13C24117ED3}\Instance"?>
<?define RegPath_ThumbExt="ShellEx\{E357FCCD-A995-4576-B01F-234630154E96}"?>


<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	<Product Id="$(var.ProductId)" Name="$(var.ProductName) $(var.PlatformUIText)" Version="$(var.ProductVersion).0"
			Language="!(loc.Language)" Manufacturer="!(loc.AuthorName)" UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Description="$(var.ProductDescr)"
				Manufacturer="!(loc.AuthorName)" Keywords="SVG,WMF,EMF,WIC,Decoder,Thumbnail,Extension,Installer,MSI,Database"
				Comments="Distributed under GNU GPLv3. Source code URL: &lt;$(var.ProductURL)&gt;" SummaryCodepage="!(loc.Codepage)"/>
		
		<MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)" AllowSameVersionUpgrades="yes"
				IgnoreRemoveFailure="yes" Schedule="afterInstallInitialize"/>

	<?ifdef Debug?>
		<Property Id="MsiLogging" Value="iwearucmov!"/>
	<?endif?>

		<Property Id="WINDOWSBUILD">
			<RegistrySearch Id="WindowsBuild" Root="HKLM" Key="$(var.RegPath_SetupNT)" Name="CurrentBuild" Type="raw"/>
		</Property>
		<Property Id="WINDOWSBUILD2">
			<RegistrySearch Id="WindowsBuild2" Root="HKLM" Key="$(var.RegPath_SetupNT)" Name="CurrentBuildNumber" Type="raw"/>
		</Property>
		
	<?if $(var.Platform) = x64?>
		<Condition Message="!(loc.x86Required)"><![CDATA[Installed OR VersionNT64]]></Condition>
	<?elseif $(var.Platform) = x86?>
		<Condition Message="!(loc.x64Required)"><![CDATA[Installed OR NOT VersionNT64]]></Condition>
	<?else?>
		<?error Platform must be either x64 or x86?>
	<?endif?>
		
		<Condition Message="!(loc.Win1703Required)">
			<![CDATA[Installed OR WINDOWSBUILD >= 15063 OR WINDOWSBUILD2 >= 15063]]>
		</Condition>
		
		<Media Id="1" Cabinet="single.cab" EmbedCab="yes"/>

		<Icon Id="AppIcon" SourceFile="$(var.ResourcePath)\SVGWView.ico"/>
		<Property Id="ARPPRODUCTICON" Value="AppIcon"/>
		<Property Id="ARPURLINFOABOUT" Value="$(var.ProductURL)"/>
		<Property Id="ARPURLUPDATEINFO" Value="$(var.ProductURL)"/>
		<Property Id="ARPHELPLINK" Value="$(var.ProductURL)"/>
		
		<Property Id="INSTALLDIR">
			<ComponentSearch Id="MainFilesDir" Guid="$(var.MainFilesGuid)" Type="directory"/>
		</Property>

		<Property Id="INSTALLLEVEL" Value="9"/>

		<PropertyRef Id="WMZKINDSET"/>
		<PropertyRef Id="EMZKINDSET"/>
		
		<Property Id="SVGTHUMBSIN">
			<ComponentSearch Id="SVGThumbsIn" Guid="$(var.SVGThumbsGuid)"/>
		</Property>
		<Property Id="WMFTHUMBSIN">
			<ComponentSearch Id="WMFThumbsIn" Guid="$(var.WMFThumbsGuid)"/>
		</Property>
		
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="$(var.ProgramFilesDir)" Name="PFiles">
				<Directory Id="INSTALLDIR" Name="$(var.KeyName)" FileSource="$(var.FileSourcePath)"/>
			</Directory>
		</Directory>
		
		<FeatureRef Id="MainProgram">
			<FeatureRef Id="SVGThumbs"/>
			<FeatureRef Id="WMFThumbs"/>
		</FeatureRef>
		
		<UIRef Id="UISequence"/>
	
	</Product>
	

	<Fragment>
		<ComponentGroup Id="MainProgram" Directory="INSTALLDIR">
			
			<Component Id="MainFiles" Guid="$(var.MainFilesGuid)" Win64="$(var.Win64)">
				<File Id="MainDll" Name="$(var.KeyName).dll" KeyPath="yes" Vital="yes" Checksum="yes" Source="$(var.FileSourcePath)\$(var.KeyName).dll"/>
			</Component>
			<Component Id="DocFiles" Guid="$(var.DocFilesGuid)">
				<File Id="GplText" Source="Res\gpl-3.0.txt"/>
				<File Id="SourceUrl" Name="Source repository.url" ShortName="Source.url" Source="Res\SourceUrl.url"/>
				<File Id="SourceZipUrl" Name="Download source.url" ShortName="SrcZip.url" Source="Res\SourceZip.url"/>
			</Component>
			
			<Component Id="SVGDecoder" Guid="$(var.SVGDecoderGuid)">
				
				<RegistryKey Root="HKCR" Key="CLSID\$(var.CLSID_SvgDecoder)" ForceDeleteOnUninstall="yes">				
					<RegistryValue Type="string" Value="!(loc.SVGDecoder)"/>
					<RegistryValue Type="string" Name="Author" Value="!(loc.AuthorName)"/>
					<RegistryValue Type="string" Name="ContainerFormat" Value="$(var.GUID_ContainerFormatSvg)"/>
					<RegistryValue Type="string" Name="FileExtensions" Value=".svg,.svgz"/>
					<RegistryValue Type="string" Name="FriendlyName" Value="!(loc.SVGDecoder)"/>
					<RegistryValue Type="string" Name="MimeTypes" Value="image/svg+xml"/>
					<RegistryValue Type="string" Name="Vendor" Value="$(var.GUID_AE_VendorID)"/>
					<RegistryValue Type="integer" Name="SupportAnimation" Value="0"/>
					<RegistryValue Type="integer" Name="SupportChromaKey" Value="1"/>
					<RegistryValue Type="integer" Name="SupportMultiframe" Value="0"/>
					
					<RegistryKey Key="InprocServer32">
						<RegistryValue Type="string" Value="[#MainDll]" KeyPath="yes"/>
						<RegistryValue Type="string" Name="ThreadingModel" Value="Both"/>
					</RegistryKey>

					<RegistryKey Key="Formats\(var.GUID_WICPixelFormat32bppBGRA)" ForceCreateOnInstall="yes"/>
					<RegistryKey Key="Formats\(var.GUID_WICPixelFormat32bppPBGRA)" ForceCreateOnInstall="yes"/>
				</RegistryKey>

				<RegistryKey Root="HKCR" Key="$(var.RegPath_WICDecoders)\$(var.CLSID_SvgDecoder)" ForceDeleteOnUninstall="yes">
					<RegistryValue Type="string" Name="CLSID" Value="$(var.CLSID_SvgDecoder)"/>
					<RegistryValue Type="string" Name="FriendlyName" Value="!(loc.SVGDecoder)"/>
				</RegistryKey>
				
			</Component>
				
			<Component Id="WMFDecoder" Guid="$(var.WMFDecoderGuid)">
				
				<RegistryKey Root="HKCR" Key="CLSID\$(var.CLSID_WmfDecoder)" ForceDeleteOnUninstall="yes">
					<RegistryValue Type="string" Value="!(loc.WMFDecoder)"/>
					<RegistryValue Type="string" Name="Author" Value="!(loc.AuthorName)"/>
					<RegistryValue Type="string" Name="ContainerFormat" Value="$(var.GUID_ContainerFormatWmf)"/>
					<RegistryValue Type="string" Name="FileExtensions" Value=".svg,.svgz"/>
					<RegistryValue Type="string" Name="FriendlyName" Value="!(loc.SVGDecoder)"/>
					<RegistryValue Type="string" Name="MimeTypes" Value="image/svg+xml"/>
					<RegistryValue Type="string" Name="Vendor" Value="$(var.GUID_AE_VendorID)"/>
					<RegistryValue Type="integer" Name="SupportAnimation" Value="0"/>
					<RegistryValue Type="integer" Name="SupportChromaKey" Value="1"/>
					<RegistryValue Type="integer" Name="SupportMultiframe" Value="0"/>

					<RegistryKey Key="InprocServer32">
						<RegistryValue Type="string" Value="[#MainDll]" KeyPath="yes"/>
						<RegistryValue Type="string" Name="ThreadingModel" Value="Both"/>
					</RegistryKey>

					<RegistryKey Key="Patterns">
						<RegistryKey Key="0">
							<RegistryValue Type="integer" Name="Length" Value="4"/>
							<RegistryValue Type="integer" Name="Position" Value="0"/>
							<RegistryValue Type="binary" Name="Mask" Value="FFFFFFFF"/>
							<RegistryValue Type="binary" Name="Pattern" Value="D7CDC69A"/>
						</RegistryKey>
						<RegistryKey Key="1">
							<RegistryValue Type="integer" Name="Length" Value="44"/>
							<RegistryValue Type="integer" Name="Position" Value="0"/>
							<RegistryValue Type="binary" Name="Mask" Value="FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF"/>
							<RegistryValue Type="binary" Name="Pattern" Value="0100000000000000000000000000000000000000000000000000000000000000000000000000000020454D46"/>
						</RegistryKey>
						<RegistryKey Key="2">
							<RegistryValue Type="integer" Name="Length" Value="6"/>
							<RegistryValue Type="integer" Name="Position" Value="0"/>
							<RegistryValue Type="binary" Name="Mask" Value="FFFF0000FFFF"/>
							<RegistryValue Type="binary" Name="Pattern" Value="020000000003"/>
						</RegistryKey>
						<RegistryKey Key="3">
							<RegistryValue Type="integer" Name="Length" Value="6"/>
							<RegistryValue Type="integer" Name="Position" Value="0"/>
							<RegistryValue Type="binary" Name="Mask" Value="FFFF0000FFFF"/>
							<RegistryValue Type="binary" Name="Pattern" Value="020000000001"/>
						</RegistryKey>
					</RegistryKey>

					<RegistryKey Key="Formats\(var.GUID_WICPixelFormat32bppBGRA)" ForceCreateOnInstall="yes"/>
					<RegistryKey Key="Formats\(var.GUID_WICPixelFormat32bppPBGRA)" ForceCreateOnInstall="yes"/>
				</RegistryKey>

				<RegistryKey Root="HKCR" Key="$(var.RegPath_WICDecoders)\$(var.CLSID_SvgDecoder)" ForceDeleteOnUninstall="yes">
					<RegistryValue Type="string" Name="CLSID" Value="$(var.CLSID_SvgDecoder)"/>
					<RegistryValue Type="string" Name="FriendlyName" Value="!(loc.SVGDecoder)"/>
				</RegistryKey>
				
			</Component>
		
		</ComponentGroup>	
		
		<Feature Id="MainProgram" Absent="disallow" AllowAdvertise="no" Display="expand" InstallDefault="local"
				ConfigurableDirectory="INSTALLDIR" Title="!(loc.MainProgram)" Description="!(loc.MainProgramDescr)">
			<ComponentGroupRef Id="MainProgram"/>
		</Feature>
	</Fragment>
	
	<Fragment>
		<Component Id="SVGThumbs" Directory="INSTALLDIR" Guid="$(var.SVGThumbsGuid)">
			
			<RegistryKey Root="HKCR" Key="CLSID\$(var.CLSID_SvgThumbnailProvider)" ForceDeleteOnUninstall="yes">
				<RegistryValue Type="string" Value="!(loc.SVGThumbs)"/>
				
				<RegistryKey Key="InprocServer32">
					<RegistryValue Type="string" Value="[#MainDll]" KeyPath="yes"/>
					<RegistryValue Type="string" Name="ThreadingModel" Value="Apartment"/>
				</RegistryKey>
			</RegistryKey>

			<RegistryKey Root="HKCR" Key=".svg">
				<RegistryValue Key="$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>
				<RegistryValue Key="DefaultIcon" Type="string" Value="[#MainDll],-101"/>
			</RegistryKey>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.svg\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>

			<RegistryKey Root="HKCR" Key=".svgz">
				<RegistryValue Key="$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>
				<RegistryValue Key="DefaultIcon" Type="string" Value="[#MainDll],-102"/>
			</RegistryKey>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.svgz\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>
			
		</Component>
		
		<Feature Id="SVGThumbs" Absent="allow" AllowAdvertise="no" InstallDefault="local"
				Level="2" Title="!(loc.SVGThumbs)" Description="!(loc.SVGThumbsDescr)">
			
			<ComponentRef Id="SVGThumbs"/>
			<ComponentRef Id="SVGTypes"/>
			
			<Condition Level="0"><![CDATA[Installed AND (NOT SVGTHUMBSIN)]]></Condition>
			
		</Feature>
	</Fragment>
	
	<Fragment>
		<Component Id="WMFThumbs" Directory="INSTALLDIR" Guid="$(var.WMFThumbsGuid)">
			
			<RegistryKey Root="HKCR" Key="CLSID\$(var.CLSID_WmfThumbnailProvider)" ForceDeleteOnUninstall="yes">
				<RegistryValue Type="string" Value="!(loc.WMFThumbs)"/>

				<RegistryKey Key="InprocServer32">
					<RegistryValue Type="string" Value="[#MainDll]" KeyPath="yes"/>
					<RegistryValue Type="string" Name="ThreadingModel" Value="Apartment"/>
				</RegistryKey>
			</RegistryKey>

			<RegistryValue Root="HKCR" Key=".emf\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.emf\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			
			<RegistryValue Root="HKCR" Key=".emz\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.emz\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			
			<RegistryValue Root="HKCR" Key=".wmf\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.wmf\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			
			<RegistryValue Root="HKCR" Key=".wmz\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
			<RegistryValue Root="HKCR" Key="SystemFileAssociations\.wmz\$(var.RegPath_ThumbExt)" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
						
		</Component>
		
		<Feature Id="WMFThumbs" Absent="allow" AllowAdvertise="no" InstallDefault="local"
				Level="2" Title="!(loc.WMFThumbs)" Description="!(loc.WMFThumbsDescr)">
			
			<ComponentRef Id="WMFThumbs"/>
			<ComponentGroupRef Id="WMFAllTypes"/>

			<Condition Level="0"><![CDATA[Installed AND (NOT WMFTHUMBSIN)]]></Condition>
			
		</Feature>
		
	</Fragment>


	<Fragment>
		<Component Id="SVGTypes" Directory="INSTALLDIR" Guid="$(var.SVGTypesGuid)">

			<RegistryKey Root="HKLM" Key="$(var.RegPath_Setup)">
				
				<RegistryKey Key="Explorer\KindMap">
					<RegistryValue Type="string" Name=".svg" Value="picture"/>
					<RegistryValue Type="string" Name=".svgz" Value="picture"/>
				</RegistryKey>
				
				<RegistryValue Key="PhotoPropertyHandler\.svg" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>
				<RegistryValue Key="PhotoPropertyHandler\.svgz" Type="string" Value="$(var.CLSID_SvgThumbnailProvider)"/>
				
			</RegistryKey>
			
		</Component>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="WMFAllTypes" Directory="INSTALLDIR">
			<Component Id="WMFTypes" Guid="$(var.WMFTypesGuid)">

				<RegistryKey Root="HKLM" Key="$(var.RegPath_Setup)">

					<RegistryKey Key="Explorer\KindMap" ForceDeleteOnUninstall="yes">
						<RegistryValue Type="string" Name=".wmf" Value="picture"/>
						<RegistryValue Type="string" Name=".emf" Value="picture"/>
					</RegistryKey>
					
					<RegistryValue Key="PhotoPropertyHandler\.wmf" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
					<RegistryValue Key="PhotoPropertyHandler\.wmz" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
					<RegistryValue Key="PhotoPropertyHandler\.emf" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
					<RegistryValue Key="PhotoPropertyHandler\.emz" Type="string" Value="$(var.CLSID_WmfThumbnailProvider)"/>
					
				</RegistryKey>
			
			</Component>

			<Component Id="WMZType">
				<RegistryValue Root="HKLM" Key="$(var.RegPath_Setup)\Explorer\KindMap" Type="string" Name=".wmz" Value="picture"/>
				<Condition><![CDATA[NOT WMZKINDSET]]></Condition>
			</Component>

			<Component Id="EMZType">
				<RegistryValue Root="HKLM" Key="$(var.RegPath_Setup)\Explorer\KindMap" Type="string" Name=".emz" Value="picture"/>
				<Condition><![CDATA[NOT EMZKINDSET]]></Condition>
			</Component>
			
		</ComponentGroup>

		<Property Id="WMZKINDSET">
			<RegistrySearch Id="WMZKindSet" Root="HKLM" Key="$(var.RegPath_Setup)\Explorer\KindMap" Name=".wmz" Type="raw"/>
		</Property>
		<Property Id="EMZKINDSET">
			<RegistrySearch Id="EMZKindSet" Root="HKLM" Key="$(var.RegPath_Setup)\Explorer\KindMap" Name=".emz" Type="raw"/>
		</Property>
		
	</Fragment>

</Wix>
